rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // === Helper Functions ===

    // Get user role from users collection
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user has one of the specified roles
    function hasRole(roles) {
      return isAuthenticated() && getUserRole() in roles;
    }

    // === User Management ===

    // === User Management ===

    match /users/{userId} {
      allow read: if isAuthenticated();
      // Allow write if self, master, or has specific user management permissions
      allow write: if isAuthenticated() &&
                      (request.auth.uid == userId || 
                       hasRole(['master']) ||
                       hasPermission('users.change_role') ||
                       hasPermission('users.approve') ||
                       hasPermission('users.change_permissions'));
    }

    // === Settings ===

    match /settings/rolePermissions {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master']) || hasPermission('settings.role_permissions');
    }

    match /settings/holidays {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master']) || hasPermission('settings.holidays');
    }

    match /settings/{document=**} {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master']) || hasPermission('settings.access');
    }

    match /system/{document=**} {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master']) || hasPermission('settings.access');
    }

    // === Timetable Collections ===

    // English Schedules (Live)
    match /english_schedules/{scheduleId} {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master']) || hasPermission('timetable.english.edit');
    }

    // English Schedules (Draft - Simulation Mode)
    match /english_schedules_draft/{scheduleId} {
      allow read: if hasRole(['master']) || hasPermission('timetable.english.simulation');
      allow write: if hasRole(['master']) || hasPermission('timetable.english.simulation');
    }

    // English Simulation Scenarios (for scenario management feature)
    match /english_simulation_scenarios/{scenarioId} {
      allow read: if hasRole(['master']) || hasPermission('timetable.english.simulation');
      allow create: if hasRole(['master']) || hasPermission('timetable.english.simulation');
      allow update: if hasRole(['master']) || hasPermission('timetable.english.simulation');
      allow delete: if hasRole(['master']) || hasPermission('timetable.english.simulation');
    }

    // Class List (수업목록)
    match /{collection}/{classId} {
      allow read: if collection == '\uC218\uC5C5\uBAA9\uB85D' && isAuthenticated();
      allow write: if collection == '\uC218\uC5C5\uBAA9\uB85D' && 
                      (hasRole(['master']) || 
                       hasPermission('timetable.math.edit') || 
                       hasPermission('timetable.english.edit'));
    }

    // Class List Draft (수업목록_draft)
    match /{collection}/{classId} {
      allow read: if collection == '\uC218\uC5C5\uBAA9\uB85D_draft' && 
                     (hasRole(['master']) || hasPermission('timetable.english.simulation'));
      allow write: if collection == '\uC218\uC5C5\uBAA9\uB85D_draft' && 
                     (hasRole(['master']) || hasPermission('timetable.english.simulation'));
    }

    // Teacher List (강사목록) - DEPRECATED: Migrated to 'staff' collection
    // NOTE: 강사 데이터가 staff 컬렉션으로 마이그레이션되었습니다.
    // 이 규칙은 삭제 예정이며, 기존 데이터 보호를 위해 읽기 전용으로 유지합니다.
    match /{collection}/{teacherId} {
      allow read: if collection == '\uAC15\uC0AC\uBAA9\uB85D' && isAuthenticated();
      allow write: if false; // 쓰기 비활성화 - staff 컬렉션 사용
    }

    // === Calendar Events (일정) ===

    // Get permission from settings/rolePermissions
    function hasPermission(permissionId) {
      let userRole = getUserRole();
      let rolePermissions = get(/databases/$(database)/documents/settings/rolePermissions).data;
      return rolePermissions[userRole][permissionId] == true;
    }

    // Calendar Events Collection (Korean collection name: 일정)
    // Note: Firestore Rules don't support Korean field names directly
    // Field names in Rules use Unicode escape sequences
    match /{collection}/{eventId} {
      // Apply rules only to "일정" collection
      allow read: if collection == '\uC77C\uC815' && isAuthenticated();

      allow create: if collection == '\uC77C\uC815' &&
                       isAuthenticated() &&
                       hasPermission('events.create') &&
                       request.resource.data['\uC791\uC131\uC790ID'] == request.auth.uid;

      allow update: if collection == '\uC77C\uC815' &&
                       isAuthenticated() && (
                         (hasPermission('events.manage_own') &&
                          resource.data['\uC791\uC131\uC790ID'] == request.auth.uid) ||
                         hasPermission('events.manage_others')
                       );

      allow delete: if collection == '\uC77C\uC815' &&
                       isAuthenticated() && (
                         (hasPermission('events.manage_own') &&
                          resource.data['\uC791\uC131\uC790ID'] == request.auth.uid) ||
                         hasPermission('events.manage_others')
                       );
    }

    // Phase 9: Archived Events Collection
    match /archived_events/{eventId} {
      allow read: if isAuthenticated();
      // Allow delete for restoration (moving back to active)
      allow delete: if isAuthenticated() && (
          hasPermission('events.manage_own') || hasPermission('events.manage_others')
      );
      // Create/Update handled by Cloud Function only
    }

    // Bucket Items Collection
    match /bucketItems/{itemId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
                       (resource.data.authorId == request.auth.uid ||
                        hasPermission('events.bucket'));
      allow delete: if isAuthenticated() &&
                       (resource.data.authorId == request.auth.uid ||
                        hasPermission('events.bucket'));
    }

    // Task Memos Collection
    match /taskMemos/{memoId} {
      allow read: if isAuthenticated() &&
                     (resource.data.to == request.auth.uid ||
                      resource.data.from == request.auth.uid);
      allow create: if isAuthenticated() &&
                       request.resource.data.from == request.auth.uid;
      allow update: if isAuthenticated() &&
                       resource.data.to == request.auth.uid; // Mark as read
      allow delete: if isAuthenticated() &&
                       (resource.data.to == request.auth.uid ||
                        resource.data.from == request.auth.uid);
    }

    // Unified Student DB (Phase 1)
    // 입력값 검증 함수
    function isValidStudent(data) {
      return data.name is string &&
             data.name.size() >= 1 &&
             data.name.size() <= 50 &&
             (!('status' in data) || data.status in ['active', 'on_hold', 'withdrawn', 'pending']);
    }

    match /students/{studentId} {
      // Read: Authenticated users (subject to component filtering)
      allow read: if isAuthenticated();

      // Write: Master, Admin, Manager, and Leads (for their respective subjects)
      // + 입력값 검증 (create/update 시)
      allow create: if isAuthenticated() &&
        isValidStudent(request.resource.data) &&
        (hasRole(['master']) ||
         hasPermission('timetable.math.edit') ||
         hasPermission('timetable.english.edit') ||
         hasPermission('attendance.manage_math') ||
         hasPermission('attendance.manage_english'));

      allow update: if isAuthenticated() &&
        isValidStudent(request.resource.data) &&
        (hasRole(['master']) ||
         hasPermission('timetable.math.edit') ||
         hasPermission('timetable.english.edit') ||
         hasPermission('attendance.manage_math') ||
         hasPermission('attendance.manage_english'));

      allow delete: if isAuthenticated() && (
        hasRole(['master']) ||
        hasPermission('timetable.math.edit') ||
        hasPermission('timetable.english.edit') ||
        hasPermission('attendance.manage_math') ||
        hasPermission('attendance.manage_english')
      );
    }

    // === Gantt Chart Collections (Phase 10: Access Control) ===

    // Phase 10 Helper Functions for Gantt Access Control
    function isProjectOwner(projectData) {
      return isAuthenticated() &&
             (projectData.createdBy == request.auth.uid ||
              (('ownerId' in projectData) && projectData.ownerId == request.auth.uid));
    }

    // Critical Issue #1 Fix: isProjectMember() 함수 추가 (2026-01-04)
    // memberIds 배열을 통해 프로젝트 멤버 여부 확인
    function isProjectMember(projectData) {
      return isAuthenticated() &&
             (('memberIds' in projectData) &&
              projectData.memberIds != null &&
              request.auth.uid in projectData.memberIds);
    }

    // Note: Firestore Rules don't support .map() on arrays of objects
    // Member check is done via memberIds array for simplicity
    // Complex member role checks are done client-side with checkProjectAccess()

    function canAccessProject(projectData) {
      // Master/Admin: Full access to all projects
      return hasRole(['master', 'admin']) ||
             // Owner: Full access
             isProjectOwner(projectData) ||
             // Member: Access via memberIds
             isProjectMember(projectData) ||
             // Public visibility: All authenticated users can view
             (('visibility' in projectData) && projectData.visibility == 'public') ||
             // Department visibility: Allow read, further filtering client-side
             (('visibility' in projectData) && projectData.visibility == 'department') ||
             (('visibility' in projectData) && projectData.visibility == 'department_shared') ||
             // Legacy: isShared flag
             (('isShared' in projectData) && projectData.isShared == true) ||
             // Legacy: assignees array (also used for new members)
             (('assignees' in projectData) && 
              projectData.assignees != null && 
              request.auth.uid in projectData.assignees);
    }

    // Gantt Templates
    match /gantt_templates/{templateId} {
      // Critical Issue #1 Fix: Fine-grained access control (2026-01-03)
      // Read: Only accessible projects (not all authenticated users)
      allow read: if canAccessProject(resource.data);

      // Create: master, admin, manager, editor roles
      allow create: if isAuthenticated() &&
                       hasRole(['master', 'admin', 'manager', 'editor']) &&
                       request.resource.data.createdBy == request.auth.uid &&
                       (('ownerId' in request.resource.data) &&
                        request.resource.data.ownerId == request.auth.uid) &&
                       // Phase 7 Validation
                       (!('tasks' in request.resource.data) ||
                        request.resource.data.tasks.size() == 0 ||
                        (!('assigneeId' in request.resource.data.tasks[0]) || request.resource.data.tasks[0].assigneeId is string) &&
                        (!('departmentIds' in request.resource.data.tasks[0]) || request.resource.data.tasks[0].departmentIds is list));

      // Update: Owner, Master/Admin, or Project Member with admin/editor role
      allow update: if isAuthenticated() && (
        isProjectOwner(resource.data) ||
        hasRole(['master', 'admin']) ||
        isProjectMember(resource.data)
      );

      // Delete: Owner or Master/Admin only
      allow delete: if isAuthenticated() && (
        isProjectOwner(resource.data) ||
        hasRole(['master', 'admin'])
      );
    }

    // Gantt Projects
    match /gantt_projects/{projectId} {
      // 읽기: 본인 프로젝트만 또는 master/admin
      allow read: if isAuthenticated() &&
                     (resource.data.ownerId == request.auth.uid ||
                      hasRole(['master', 'admin']));

      // 생성: master, admin, manager, editor 권한
      allow create: if isAuthenticated() &&
                       hasRole(['master', 'admin', 'manager', 'editor']) &&
                       request.resource.data.ownerId == request.auth.uid;

      // 수정: 본인 프로젝트만 또는 master/admin
      allow update: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        hasRole(['master', 'admin']));

      // 삭제: 본인 프로젝트만 또는 master/admin
      allow delete: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        hasRole(['master', 'admin']));
    }

    // === Consultation Records (Phase 13: EduCRM Integration) ===
    match /consultations/{consultationId} {
      // Read: All authenticated users can view
      allow read: if isAuthenticated();

      // Create/Update: Master or users with consultation permission
      allow create, update: if hasRole(['master']) ||
                              hasPermission('consultations.edit') ||
                              hasPermission('consultations.create');

      // Delete: Only master
      allow delete: if hasRole(['master']);
    }

    // === Class Management (Korean collection names) ===
    // Using wildcard match for Korean collection names

    // Note: 수업목록 is handled by specific match groups above
    // 강사목록 is DEPRECATED - use staff collection instead

    // === Class Keywords ===
    match /classKeywords/{keywordId} {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master']) || hasPermission('system.classes.edit');
    }

    // === Default: Deny by Default ===
    // Explicit rules above handle all known collections
    // This fallback denies access to undefined collections for safety
    // NOTE: 새 컬렉션 추가 시 위에 명시적 규칙 필요

    match /{document=**} {
      // 기본 거부 - 명시적으로 허용된 컬렉션만 접근 가능
      // Master/Admin은 새 컬렉션 테스트를 위해 접근 허용
      allow read: if hasRole(['master', 'admin']);
      allow write: if hasRole(['master']);
    }
  }
}
