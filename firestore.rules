rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // === Helper Functions ===

    // staffIndex 컬렉션에서 uid로 systemRole 조회
    // staffIndex/{uid} 문서 구조: { staffId, systemRole, updatedAt }
    function getStaffRoleByUid(uid) {
      return get(/databases/$(database)/documents/staffIndex/$(uid)).data.systemRole;
    }

    // 레거시 호환: getUserRole은 staffIndex 사용
    function getUserRole() {
      return getStaffRoleByUid(request.auth.uid);
    }

    // staff 컬렉션의 문서 ID로 role 가져오기
    function getStaffRole(staffId) {
      return get(/databases/$(database)/documents/staff/$(staffId)).data.systemRole;
    }

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user has one of the specified roles
    function hasRole(roles) {
      return isAuthenticated() && getUserRole() in roles;
    }

    // === Staff Index (uid → systemRole 매핑) ===
    // staff 컬렉션의 문서 ID가 auto-generated이므로, uid로 빠르게 역할을 조회하기 위한 인덱스
    // staff 생성/업데이트 시 자동 동기화됨
    match /staffIndex/{uid} {
      allow read: if isAuthenticated();
      // 본인 문서 생성/업데이트 허용 (초기 등록 시)
      // master/admin은 다른 사용자의 인덱스도 수정 가능
      allow create: if isAuthenticated() && uid == request.auth.uid;
      allow update: if isAuthenticated() && (
        uid == request.auth.uid ||
        hasRole(['master', 'admin'])
      );
      allow delete: if false; // 삭제 차단
    }


    // === Staff Management (New User System) ===
    match /staff/{staffId} {
      // Read: All authenticated users can read staff list
      allow read: if isAuthenticated();

      // Create: Authenticated users can create their own profile during registration
      allow create: if isAuthenticated() &&
                      (request.resource.data.uid == request.auth.uid ||
                       resource.data.systemRole == 'master');

      // Update: Self or users with master/admin systemRole in their staff document
      allow update: if isAuthenticated() && (
                      resource.data.uid == request.auth.uid ||
                      getStaffRoleByUid(request.auth.uid) in ['master', 'admin']
                    );

      // Delete: Users with master/admin systemRole (checked via staff document)
      allow delete: if isAuthenticated() &&
                      getStaffRoleByUid(request.auth.uid) in ['master', 'admin'];
    }

    // === Settings ===

    match /settings/rolePermissions {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master']) || hasPermission('settings.role_permissions');
    }

    match /settings/holidays {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master']) || hasPermission('settings.holidays');
    }

    match /settings/{document=**} {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master']) || hasPermission('settings.access');
    }

    match /system/{document=**} {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master']) || hasPermission('settings.access');
    }

    // === Timetable Collections ===

    // English Schedules (Live)
    match /english_schedules/{scheduleId} {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master']) || hasPermission('timetable.english.edit');
    }

    // English Schedules (Draft - Simulation Mode)
    match /english_schedules_draft/{scheduleId} {
      allow read: if hasRole(['master']) || hasPermission('timetable.english.simulation');
      allow write: if hasRole(['master']) || hasPermission('timetable.english.simulation');
    }

    // English Simulation Scenarios (for scenario management feature)
    match /english_simulation_scenarios/{scenarioId} {
      allow read: if hasRole(['master']) || hasPermission('timetable.english.simulation');
      allow create: if hasRole(['master']) || hasPermission('timetable.english.simulation');
      allow update: if hasRole(['master']) || hasPermission('timetable.english.simulation');
      allow delete: if hasRole(['master']) || hasPermission('timetable.english.simulation');
    }

    // Math Simulation Scenarios (for math scenario management feature)
    match /math_scenarios/{scenarioId} {
      allow read: if hasRole(['master']) || hasPermission('timetable.math.simulation');
      allow create: if hasRole(['master']) || hasPermission('timetable.math.simulation');
      allow update: if hasRole(['master']) || hasPermission('timetable.math.simulation');
      allow delete: if hasRole(['master']) || hasPermission('timetable.math.simulation');
    }

    // Class List (수업목록)
    match /{collection}/{classId} {
      allow read: if collection == '\uC218\uC5C5\uBAA9\uB85D' && isAuthenticated();
      allow write: if collection == '\uC218\uC5C5\uBAA9\uB85D' && 
                      (hasRole(['master']) || 
                       hasPermission('timetable.math.edit') || 
                       hasPermission('timetable.english.edit'));
    }

    // Class List Draft (수업목록_draft)
    match /{collection}/{classId} {
      allow read: if collection == '\uC218\uC5C5\uBAA9\uB85D_draft' && 
                     (hasRole(['master']) || hasPermission('timetable.english.simulation'));
      allow write: if collection == '\uC218\uC5C5\uBAA9\uB85D_draft' && 
                     (hasRole(['master']) || hasPermission('timetable.english.simulation'));
    }

    // Teacher List (강사목록) - DEPRECATED: Migrated to 'staff' collection
    // NOTE: 강사 데이터가 staff 컬렉션으로 마이그레이션되었습니다.
    // 이 규칙은 삭제 예정이며, 기존 데이터 보호를 위해 읽기 전용으로 유지합니다.
    match /{collection}/{teacherId} {
      allow read: if collection == '\uAC15\uC0AC\uBAA9\uB85D' && isAuthenticated();
      allow write: if false; // 쓰기 비활성화 - staff 컬렉션 사용
    }

    // === Calendar Events (일정) ===

    // Get permission from settings/rolePermissions
    function hasPermission(permissionId) {
      let userRole = getUserRole();
      let rolePermissions = get(/databases/$(database)/documents/settings/rolePermissions).data;
      return rolePermissions[userRole][permissionId] == true;
    }

    // Calendar Events Collection (Korean collection name: 일정)
    // Note: Firestore Rules don't support Korean field names directly
    // Field names in Rules use Unicode escape sequences
    match /{collection}/{eventId} {
      // Apply rules only to "일정" collection
      allow read: if collection == '\uC77C\uC815' && isAuthenticated();

      allow create: if collection == '\uC77C\uC815' &&
                       isAuthenticated() &&
                       hasPermission('events.create') &&
                       request.resource.data['\uC791\uC131\uC790ID'] == request.auth.uid;

      allow update: if collection == '\uC77C\uC815' &&
                       isAuthenticated() && (
                         (hasPermission('events.manage_own') &&
                          resource.data['\uC791\uC131\uC790ID'] == request.auth.uid) ||
                         hasPermission('events.manage_others')
                       );

      allow delete: if collection == '\uC77C\uC815' &&
                       isAuthenticated() && (
                         (hasPermission('events.manage_own') &&
                          resource.data['\uC791\uC131\uC790ID'] == request.auth.uid) ||
                         hasPermission('events.manage_others')
                       );
    }

    // Phase 9: Archived Events Collection
    match /archived_events/{eventId} {
      allow read: if isAuthenticated();
      // Allow delete for restoration (moving back to active)
      allow delete: if isAuthenticated() && (
          hasPermission('events.manage_own') || hasPermission('events.manage_others')
      );
      // Create/Update handled by Cloud Function only
    }

    // Bucket Items Collection
    match /bucketItems/{itemId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
                       (resource.data.authorId == request.auth.uid ||
                        hasPermission('events.bucket'));
      allow delete: if isAuthenticated() &&
                       (resource.data.authorId == request.auth.uid ||
                        hasPermission('events.bucket'));
    }

    // Task Memos Collection
    match /taskMemos/{memoId} {
      allow read: if isAuthenticated() &&
                     (resource.data.to == request.auth.uid ||
                      resource.data.from == request.auth.uid);
      allow create: if isAuthenticated() &&
                       request.resource.data.from == request.auth.uid;
      allow update: if isAuthenticated() &&
                       resource.data.to == request.auth.uid; // Mark as read
      allow delete: if isAuthenticated() &&
                       (resource.data.to == request.auth.uid ||
                        resource.data.from == request.auth.uid);
    }

    // Unified Student DB (Phase 1)
    // 입력값 검증 함수
    function isValidStudent(data) {
      return data.name is string &&
             data.name.size() >= 1 &&
             data.name.size() <= 50 &&
             (!('status' in data) || data.status in ['active', 'on_hold', 'withdrawn', 'pending']);
    }

    match /students/{studentId} {
      // Read: master/admin 또는 students.view 권한
      allow read: if hasRole(['master', 'admin']) || hasPermission('students.view');

      // Create/Update: master/admin 또는 students.edit 권한
      allow create, update: if isAuthenticated() &&
        isValidStudent(request.resource.data) &&
        (hasRole(['master', 'admin']) || hasPermission('students.edit'));

      // Delete: master/admin 또는 students.delete 권한
      allow delete: if hasRole(['master', 'admin']) || hasPermission('students.delete');
    }

    // Student Enrollments Subcollection (수강 이력)
    match /students/{studentId}/enrollments/{enrollmentId} {
      // Read: master/admin 또는 students.view 권한
      allow read: if hasRole(['master', 'admin']) || hasPermission('students.view');

      // Write: master/admin 또는 students.enrollment.manage 권한
      allow create, update, delete: if hasRole(['master', 'admin']) ||
        hasPermission('students.enrollment.manage');
    }

    // === Gantt Chart Collections (Phase 10: Access Control) ===

    // Phase 10 Helper Functions for Gantt Access Control
    function isProjectOwner(projectData) {
      return isAuthenticated() &&
             (projectData.createdBy == request.auth.uid ||
              (('ownerId' in projectData) && projectData.ownerId == request.auth.uid));
    }

    // Critical Issue #1 Fix: isProjectMember() 함수 추가 (2026-01-04)
    // memberIds 배열을 통해 프로젝트 멤버 여부 확인
    function isProjectMember(projectData) {
      return isAuthenticated() &&
             (('memberIds' in projectData) &&
              projectData.memberIds != null &&
              request.auth.uid in projectData.memberIds);
    }

    // Note: Firestore Rules don't support .map() on arrays of objects
    // Member check is done via memberIds array for simplicity
    // Complex member role checks are done client-side with checkProjectAccess()

    function canAccessProject(projectData) {
      // Master/Admin: Full access to all projects
      return hasRole(['master', 'admin']) ||
             // Owner: Full access
             isProjectOwner(projectData) ||
             // Member: Access via memberIds
             isProjectMember(projectData) ||
             // Public visibility: All authenticated users can view
             (('visibility' in projectData) && projectData.visibility == 'public') ||
             // Department visibility: Allow read, further filtering client-side
             (('visibility' in projectData) && projectData.visibility == 'department') ||
             (('visibility' in projectData) && projectData.visibility == 'department_shared') ||
             // Legacy: isShared flag
             (('isShared' in projectData) && projectData.isShared == true) ||
             // Legacy: assignees array (also used for new members)
             (('assignees' in projectData) && 
              projectData.assignees != null && 
              request.auth.uid in projectData.assignees);
    }

    // Gantt Templates
    match /gantt_templates/{templateId} {
      // Critical Issue #1 Fix: Fine-grained access control (2026-01-03)
      // Read: Only accessible projects (not all authenticated users)
      allow read: if canAccessProject(resource.data);

      // Create: master, admin, manager, editor roles
      allow create: if isAuthenticated() &&
                       hasRole(['master', 'admin', 'manager', 'editor']) &&
                       request.resource.data.createdBy == request.auth.uid &&
                       (('ownerId' in request.resource.data) &&
                        request.resource.data.ownerId == request.auth.uid) &&
                       // Phase 7 Validation
                       (!('tasks' in request.resource.data) ||
                        request.resource.data.tasks.size() == 0 ||
                        (!('assigneeId' in request.resource.data.tasks[0]) || request.resource.data.tasks[0].assigneeId is string) &&
                        (!('departmentIds' in request.resource.data.tasks[0]) || request.resource.data.tasks[0].departmentIds is list));

      // Update: Owner, Master/Admin, or Project Member with admin/editor role
      allow update: if isAuthenticated() && (
        isProjectOwner(resource.data) ||
        hasRole(['master', 'admin']) ||
        isProjectMember(resource.data)
      );

      // Delete: Owner or Master/Admin only
      allow delete: if isAuthenticated() && (
        isProjectOwner(resource.data) ||
        hasRole(['master', 'admin'])
      );
    }

    // Gantt Projects
    match /gantt_projects/{projectId} {
      // 읽기: 본인 프로젝트만 또는 master/admin
      allow read: if isAuthenticated() &&
                     (resource.data.ownerId == request.auth.uid ||
                      hasRole(['master', 'admin']));

      // 생성: master, admin, manager, editor 권한
      allow create: if isAuthenticated() &&
                       hasRole(['master', 'admin', 'manager', 'editor']) &&
                       request.resource.data.ownerId == request.auth.uid;

      // 수정: 본인 프로젝트만 또는 master/admin
      allow update: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        hasRole(['master', 'admin']));

      // 삭제: 본인 프로젝트만 또는 master/admin
      allow delete: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        hasRole(['master', 'admin']));
    }

    // === Consultation Records (Phase 13: EduCRM Integration) ===
    match /consultations/{consultationId} {
      // Read: All authenticated users can view
      allow read: if isAuthenticated();

      // Create/Update: Master or users with consultation permission
      allow create, update: if hasRole(['master']) ||
                              hasPermission('consultations.edit') ||
                              hasPermission('consultations.create');

      // Delete: Only master
      allow delete: if hasRole(['master']);
    }

    // === Student Consultation Records (학생 상담 기록) ===
    match /student_consultations/{consultationId} {
      // Read: All authenticated users can view
      allow read: if isAuthenticated();

      // Create/Update: Master or users with consultation permission
      allow create, update: if hasRole(['master']) ||
                              hasPermission('consultation.create') ||
                              hasPermission('consultation.edit');

      // Delete: Only master or users with consultation edit permission
      allow delete: if hasRole(['master']) ||
                       hasPermission('consultation.edit');
    }

    // === Class Management (Korean collection names) ===
    // Using wildcard match for Korean collection names

    // Note: 수업목록 is handled by specific match groups above
    // 강사목록 is DEPRECATED - use staff collection instead

    // === Class Keywords ===
    match /classKeywords/{keywordId} {
      allow read: if isAuthenticated();
      allow write: if hasRole(['master', 'admin']) || hasPermission('system.classes.edit');
    }

    // === Classes Collection (수업 관리) ===
    match /classes/{classId} {
      // Read: master/admin 또는 classes.view 권한
      allow read: if hasRole(['master', 'admin']) || hasPermission('classes.view');

      // Create: master/admin 또는 classes.create 권한
      allow create: if hasRole(['master', 'admin']) || hasPermission('classes.create');

      // Update: master/admin 또는 classes.edit 권한
      allow update: if hasRole(['master', 'admin']) || hasPermission('classes.edit');

      // Delete: master/admin 또는 classes.delete 권한
      allow delete: if hasRole(['master', 'admin']) || hasPermission('classes.delete');

      // students subcollection
      match /students/{studentId} {
        allow read: if hasRole(['master', 'admin']) || hasPermission('classes.view');
        allow write: if hasRole(['master', 'admin']) || hasPermission('classes.edit');
      }
    }

    // === Grades Collection (성적 관리) ===
    match /grades/{gradeId} {
      allow read: if hasRole(['master', 'admin']) || hasPermission('grades.view');
      allow create, update: if hasRole(['master', 'admin']) || hasPermission('grades.edit');
      allow delete: if hasRole(['master', 'admin']) || hasPermission('grades.edit');
    }

    match /exams/{examId} {
      allow read: if hasRole(['master', 'admin']) || hasPermission('grades.view');
      allow create, update, delete: if hasRole(['master', 'admin']) || hasPermission('grades.manage_exams');
    }

    match /exam_series/{seriesId} {
      allow read: if hasRole(['master', 'admin']) || hasPermission('grades.view');
      allow create, update, delete: if hasRole(['master', 'admin']) || hasPermission('grades.manage_exams');
    }

    // === Billing Collection (수납 관리) ===
    match /billing/{billingId} {
      allow read: if hasRole(['master', 'admin']) || hasPermission('billing.view');
      allow create, update, delete: if hasRole(['master', 'admin']) || hasPermission('billing.edit');
    }

    // === Attendance Collection (출석 관리) ===
    match /attendance/{attendanceId} {
      allow read: if hasRole(['master', 'admin']) ||
                     hasPermission('attendance.manage_own') ||
                     hasPermission('attendance.edit_all');
      allow create, update: if hasRole(['master', 'admin']) ||
                               hasPermission('attendance.edit_all') ||
                               hasPermission('attendance.manage_math') ||
                               hasPermission('attendance.manage_english');
      allow delete: if hasRole(['master', 'admin']) || hasPermission('attendance.edit_all');
    }

    match /daily_attendance/{docId} {
      allow read: if hasRole(['master', 'admin']) ||
                     hasPermission('attendance.manage_own') ||
                     hasPermission('attendance.edit_all');
      allow create, update: if hasRole(['master', 'admin']) ||
                               hasPermission('attendance.edit_all') ||
                               hasPermission('attendance.manage_math') ||
                               hasPermission('attendance.manage_english');
      allow delete: if hasRole(['master', 'admin']) || hasPermission('attendance.edit_all');

      // Daily attendance records subcollection (날짜별 출결 기록)
      // Critical Security Fix: Add granular rules for records subcollection
      match /records/{recordId} {
        allow read: if hasRole(['master', 'admin']) ||
                       hasPermission('attendance.manage_own') ||
                       hasPermission('attendance.edit_all');

        allow create, update: if hasRole(['master', 'admin']) ||
                                 hasPermission('attendance.edit_all') ||
                                 hasPermission('attendance.manage_math') ||
                                 hasPermission('attendance.manage_english');

        allow delete: if hasRole(['master', 'admin']) ||
                         hasPermission('attendance.edit_all');
      }
    }

    // === Attendance History (출결 변경 이력) ===
    match /attendance_history/{historyId} {
      // Read: 인증된 사용자 모두 조회 가능 (감사 추적용)
      allow read: if isAuthenticated();

      // Create: Batch write에서만 생성하므로 일반적으로 서버에서 처리
      // 하지만 클라이언트에서도 생성 가능하도록 권한 부여
      allow create: if hasRole(['master', 'admin']) ||
                       hasPermission('attendance.edit_all') ||
                       hasPermission('attendance.manage_math') ||
                       hasPermission('attendance.manage_english');

      // Update/Delete: 이력은 수정/삭제 불가 (감사 추적 보호)
      allow update, delete: if false;
    }

    // === Grade Profile Collections (Phase 1-4: 성적 프로필 시스템) ===

    // Level Tests (레벨테스트)
    match /level_tests/{testId} {
      allow read: if hasRole(['master', 'admin']) || hasPermission('grades.view');
      allow create, update, delete: if hasRole(['master', 'admin']) || hasPermission('grades.edit');
    }

    // Goal Settings (목표 점수)
    match /goal_settings/{goalId} {
      allow read: if hasRole(['master', 'admin']) || hasPermission('grades.view');
      allow create, update, delete: if hasRole(['master', 'admin']) || hasPermission('grades.edit');
    }

    // Grade Comments (강사 코멘트)
    match /grade_comments/{commentId} {
      allow read: if hasRole(['master', 'admin']) || hasPermission('grades.view');
      allow create, update, delete: if hasRole(['master', 'admin']) || hasPermission('grades.edit');
    }

    // === Default: Role-Based Access for All Collections ===
    // 위에 명시적 규칙이 없는 컬렉션에 적용
    // master/admin만 쓰기 가능, 읽기는 인증된 사용자

    match /{document=**} {
      // Read: 모든 인증된 사용자 (세부 권한은 클라이언트에서 제어)
      allow read: if isAuthenticated();

      // Write: master/admin만 허용 (명시적 규칙이 없는 컬렉션)
      allow write: if hasRole(['master', 'admin']);
    }
  }
}
