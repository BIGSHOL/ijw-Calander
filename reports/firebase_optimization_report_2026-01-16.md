# 상담 관리 탭 Firebase 비용 절감/성능 최적화 검토 보고서

## 1. 현황 분석
현재 `useStudentConsultations` 훅과 `ConsultationManagementTab` 컴포넌트의 데이터 로딩 방식을 분석한 결과, 데이터 양이 증가할수록 **읽기 비용이 급증**하고 **로딩 성능이 저하**될 수 있는 구조임을 확인했습니다.

### 주요 문제점
1.  **모든 데이터 조회 (Full Scan)**:
    - 필터(학생ID 등)가 없으면 컬렉션의 **모든 문서**를 가져옵니다 (`getDocs(collection/query)`).
    - 예: 상담 기록이 1,000건이면, 탭을 열 때마다 1,000번의 읽기가 발생합니다.
    - 데이터가 1만 건으로 늘어나면 속도가 매우 느려지고 비용이 많이 듭니다.
2.  **공격적인 캐시 무효화**:
    - `staleTime: 0`과 `refetchOnWindowFocus: true` 설정으로 인해, 브라우저 탭을 갔다 올 때마다 전체 데이터를 다시 읽어옵니다.
    - 불필요한 중복 읽기가 매우 빈번하게 발생합니다.
3.  **클라이언트 사이드 페이지네이션**:
    - 최근 10/20개만 보더라도, 실제로는 전체 데이터를 다 가져온 후 브라우저에서 자릅니다.

## 2. 최적화 제안

비용 절감 효과와 구현 난이도에 따라 3단계의 최적화 방안을 제안합니다.

### 1단계: 캐싱 정책 개선 (즉시 적용 권장)
가장 적은 수정으로 중복 읽기를 획기적으로 줄일 수 있습니다.

*   **변경 내용**:
    *   `staleTime`을 0분 → **5~10분**으로 증가.
    *   `refetchOnWindowFocus`를 **false**로 변경. (명시적인 '새로고침' 버튼으로만 갱신)
    *   데이터 수정/추가 시에만 `refetch` 또는 `invalidateQueries`로 캐시 갱신.
*   **예상 효과**: 사용자가 탭을 자주 이동해도 추가 비용 0.

### 2단계: 최신 데이터 우선 조회 (Limit 적용)
대부분의 사용자는 "최근 상담"을 확인합니다. 전체 데이터를 다 가져오는 대신 최근 N개만 가져오도록 제한합니다.

*   **변경 내용**:
    *   기본 쿼리에 `orderBy('date', 'desc')`와 `limit(100)` (또는 200) 적용.
    *   "지난 내역 더보기" 버튼을 통해 추가 데이터를 로드하도록 변경 (Infinite Query 방식 도입 고려).
*   **Trade-off**:
    *   **검색 제한**: 전체 데이터 대상 검색(텍스트 검색)이 로드된 데이터 내에서만 가능해집니다. (예: 1년 전 상담 내용을 검색하려면 별도 전체 검색 기능이 필요)
*   **예상 효과**: 데이터 양이 아무리 늘어나도 1회 로딩 시 100건(고정 비용)으로 제한됨.

### 3단계: 조회 수 최적화 (Firestore Count API 도입)
단순히 "총 N건"을 표시하기 위해 문서를 모두 읽는 것은 비효율적입니다.

*   **변경 내용**:
    *   `getDocs` 대신 `getCountFromServer`를 사용하여 총 개수만 별도로 조회 (비용 1/1000).
    *   실제 목록용 데이터는 필요한 페이지 양만큼만 조회.

---

## 3. 추천 실행 계획

현재 앱의 사용성과 비용 효율을 고려하여 **[1단계 + 2단계 일부]** 적용을 추천합니다.

1.  **캐싱 타임 증가**: `hooks/useStudentConsultations.ts`의 React Query 설정 변경.
2.  **기본 조회 제한**: 기본적으로 최근 200건만 가져오도록 `limit` 추가.
3.  **검색 UX 조정**: 검색 시에는 서버에 전체 쿼리를 날리거나(비용 발생), "최근 200건 내 검색"으로 제한하고 필요시 "더 불러오기" 제공.

**현재 페이지네이션(10/20...) 기능과의 조화:**
사용자가 요청한 10/20 단위 페이지네이션을 유지하면서 비용을 아끼려면, **최근 200건을 한 번에 가져와서 로컬에서 10개씩 페이징**해 보여주는 것이 사용자 경험(빠른 반응)과 비용(적절한 제한) 사이의 균형이 가장 좋습니다.

### 승인 요청
**2026-01-16 업데이트**: 사용자의 요청으로 **1단계(캐싱 강화)** 및 **2단계(최근 200건 제한)** 코드가 **적용 완료**되었습니다.
- `hooks/useStudentConsultations.ts` 수정됨.
- `staleTime`: 0분 -> 5분
- `limit`: 200 적용
- `orderBy`: date desc 적용
- `refetchOnWindowFocus`: false 적용
