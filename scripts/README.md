# 데이터 마이그레이션 가이드

## 개요

학생 관리 시스템을 학생 중심 데이터 구조로 전환하기 위한 마이그레이션 스크립트입니다.

### 기존 구조
```
수업목록/{classId}
  └─ students: ["학생1", "학생2", ...]

english_schedules/{teacher}
  └─ merged: [
       {
         className: "PL6",
         students: ["학생1", "학생2", ...]
       }
     ]
```

### 새 구조
```
students/{studentId}
  └─ enrollments/{enrollmentId}
     ├─ subject: "math" | "english"
     ├─ className: "수요일 1교시"
     ├─ teacherId: "김민주"
     ├─ days: ["수", "목"]
     └─ ...
```

## 실행 방법

### 1단계: 마이그레이션 실행

```bash
npm run migrate
```

**수행 작업:**
- 기존 데이터는 그대로 유지
- 새로운 `students/{id}/enrollments` 서브컬렉션 생성
- 수학/영어 시간표의 모든 학생 데이터를 enrollments로 복사

**출력 예시:**
```
🚀 데이터 마이그레이션 시작

📘 수학 시간표 마이그레이션 시작...
   발견된 수학 수업: 15개
   처리 중: 수요일 1교시 (학생 3명)
   ✨ 학생 문서 생성: 강수정
   ...
✅ 수학 마이그레이션 완료: 45개 enrollment 생성

📗 영어 시간표 마이그레이션 시작...
   발견된 영어 스케줄: 5개
   ...
✅ 영어 마이그레이션 완료: 30개 enrollment 생성

📊 마이그레이션 결과 요약
총 enrollments: 75개
처리된 학생: 25명
```

### 2단계: 검증

```bash
npm run validate
```

**수행 작업:**
- 기존 데이터와 마이그레이션된 데이터 비교
- 각 학생별로 수업 목록 일치 여부 확인
- 불일치 사항 상세 리포트

**출력 예시:**
```
🔍 마이그레이션 검증 시작

📋 학생 목록 수집 중...
   총 25명 발견

   검증 중: 강수정
   검증 중: 김민준
   ...

📊 검증 결과 요약
✅ 일치: 25명
❌ 불일치: 0명

🎉 모든 데이터가 정확히 마이그레이션되었습니다!
```

### 3단계: UI에서 테스트

설정 탭에 "데이터 전환" 토글 버튼이 추가됩니다:

- **OFF (기본)**: 기존 데이터 구조 사용
- **ON**: 새 enrollments 구조 사용

토글을 켜서 학생 관리 탭과 시간표가 정상 작동하는지 확인하세요.

## 주의사항

### ⚠️ 실행 전 확인사항

1. **Firebase 백업**: 혹시 모를 상황에 대비해 Firestore 데이터를 백업하세요
2. **테스트 환경**: 가능하면 테스트 Firebase 프로젝트에서 먼저 실행
3. **권한 확인**: Firebase 콘솔에서 쓰기 권한이 있는지 확인

### 🔒 안전 장치

- 기존 데이터는 절대 삭제되지 않습니다
- 마이그레이션은 새 컬렉션에만 쓰기 작업을 수행합니다
- 실패 시 자동으로 롤백되지는 않지만, 기존 데이터가 그대로 남아있어 복구 가능합니다

### 🐛 문제 발생 시

1. **일부 학생 누락**: `validate` 명령으로 불일치 학생 확인
2. **권한 오류**: Firebase 콘솔에서 Firestore Rules 확인
3. **데이터 불일치**: 기존 구조로 돌아가려면 UI에서 토글을 OFF로 변경

## 롤백 방법

마이그레이션된 데이터를 삭제하고 싶다면:

```javascript
// Firebase 콘솔에서 실행
// students 컬렉션의 enrollments 서브컬렉션만 삭제
```

또는 UI에서 토글을 OFF로 두고 계속 기존 구조 사용 가능.

## 다음 단계

마이그레이션 완료 후:

1. ✅ UI 토글로 충분히 테스트
2. ✅ 모든 기능 정상 작동 확인
3. ✅ 학생 관리에서 수업 추가/삭제 기능 구현
4. ✅ 시간표에서 새 데이터 읽기 구현
5. 🔄 기존 students 필드 정리 (선택사항)

## 도움말

문제가 발생하면:
- `scripts/migrateToEnrollments.ts` 로그 확인
- Firebase 콘솔에서 데이터 직접 확인
- 검증 스크립트 재실행으로 문제 파악
